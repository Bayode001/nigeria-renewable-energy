<!DOCTYPE html>
<html>
<head>
    <title>Energy Data Pipeline Monitoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <style>
        .status-card { transition: all 0.3s; }
        .status-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-healthy { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-critical { background-color: #dc3545; }
        .refresh-badge { cursor: pointer; }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <h1 class="mb-4">Nigeria Energy Data Pipeline Monitoring</h1>
        
        <!-- Status Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body">
                        <h5 class="card-title">Data Freshness</h5>
                        <h2 id="data-freshness">--</h2>
                        <span class="badge bg-success" id="freshness-status">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body">
                        <h5 class="card-title">API Health</h5>
                        <h2 id="api-health">--</h2>
                        <span class="badge bg-success" id="api-status">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body">
                        <h5 class="card-title">Database</h5>
                        <h2 id="db-status">--</h2>
                        <span class="badge bg-success" id="db-health">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card">
                    <div class="card-body">
                        <h5 class="card-title">Active Alerts</h5>
                        <h2 id="active-alerts">0</h2>
                        <span class="badge bg-danger refresh-badge" onclick="loadAlerts()">View Alerts</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Data Update Frequency</div>
                    <div class="card-body">
                        <canvas id="updateChart" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">API Response Times</div>
                    <div class="card-body">
                        <canvas id="responseChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Updates -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <span>Recent Data Updates</span>
                        <button class="btn btn-sm btn-primary" onclick="loadRecentUpdates()">Refresh</button>
                    </div>
                    <div class="card-body">
                        <table class="table" id="updates-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Source</th>
                                    <th>Status</th>
                                    <th>Records</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="updates-body">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration
        const API_BASE = '/api/monitoring';
        let updateChart, responseChart;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            setInterval(loadDashboard, 30000); // Refresh every 30 seconds
        });
        
        async function loadDashboard() {
            try {
                const [status, updates, alerts] = await Promise.all([
                    fetch(`${API_BASE}/status`).then(r => r.json()),
                    fetch(`${API_BASE}/recent-updates`).then(r => r.json()),
                    fetch(`${API_BASE}/alerts`).then(r => r.json())
                ]);
                
                updateStatus(status);
                updateCharts(updates);
                updateAlerts(alerts);
                updateRecentUpdates(updates);
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        function updateStatus(status) {
            // Data Freshness
            const freshness = status.data_freshness_minutes;
            document.getElementById('data-freshness').textContent = `${freshness}m`;
            const freshnessElem = document.getElementById('freshness-status');
            
            if (freshness < 60) {
                freshnessElem.className = 'badge bg-success';
                freshnessElem.textContent = 'Healthy';
            } else if (freshness < 120) {
                freshnessElem.className = 'badge bg-warning';
                freshnessElem.textContent = 'Warning';
            } else {
                freshnessElem.className = 'badge bg-danger';
                freshnessElem.textContent = 'Critical';
            }
            
            // API Health
            const apiHealth = status.api_health;
            document.getElementById('api-health').textContent = `${apiHealth}%`;
            const apiStatus = document.getElementById('api-status');
            
            if (apiHealth > 95) {
                apiStatus.className = 'badge bg-success';
                apiStatus.textContent = 'Healthy';
            } else if (apiHealth > 80) {
                apiStatus.className = 'badge bg-warning';
                apiStatus.textContent = 'Degraded';
            } else {
                apiStatus.className = 'badge bg-danger';
                apiStatus.textContent = 'Critical';
            }
            
            // Database Status
            const dbStatus = status.database_status;
            document.getElementById('db-status').textContent = dbStatus.connections;
            const dbHealth = document.getElementById('db-health');
            
            if (dbStatus.healthy) {
                dbHealth.className = 'badge bg-success';
                dbHealth.textContent = 'Healthy';
            } else {
                dbHealth.className = 'badge bg-danger';
                dbHealth.textContent = 'Issues';
            }
            
            // Active Alerts
            document.getElementById('active-alerts').textContent = alerts.length;
        }
        
        function updateCharts(updates) {
            // Update frequency chart
            const updateCtx = document.getElementById('updateChart').getContext('2d');
            
            if (!updateChart) {
                updateChart = new Chart(updateCtx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Update Frequency (minutes)',
                            data: updates.map(u => ({
                                x: new Date(u.timestamp),
                                y: u.duration_minutes
                            })),
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'hour'
                                }
                            },
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } else {
                updateChart.data.datasets[0].data = updates.map(u => ({
                    x: new Date(u.timestamp),
                    y: u.duration_minutes
                }));
                updateChart.update();
            }
        }
        
        function updateRecentUpdates(updates) {
            const tbody = document.getElementById('updates-body');
            tbody.innerHTML = '';
            
            updates.slice(0, 10).forEach(update => {
                const row = document.createElement('tr');
                
                let statusBadge;
                if (update.status === 'success') {
                    statusBadge = '<span class="badge bg-success">Success</span>';
                } else if (update.status === 'warning') {
                    statusBadge = '<span class="badge bg-warning">Warning</span>';
                } else {
                    statusBadge = '<span class="badge bg-danger">Failed</span>';
                }
                
                row.innerHTML = `
                    <td>${new Date(update.timestamp).toLocaleString()}</td>
                    <td>${update.source}</td>
                    <td>${statusBadge}</td>
                    <td>${update.records_processed || 0}</td>
                    <td>${update.duration_ms || 0}ms</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewUpdateDetails('${update.id}')">
                            Details
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function loadAlerts() {
            // Implement alert modal or page
            alert('Alert details would open here');
        }
        
        function viewUpdateDetails(updateId) {
            // Implement detailed view
            alert(`Details for update ${updateId}`);
        }
    </script>
</body>
</html>